/*! h8 - v0.2.3 - 2014-04-19 */
(function(){function h8(){function a(a){var b=f,c=a.length;if(d=d.concat(a),f+=c,g+=c,h=UintArrayLengthen(h,f),e.length)for(_.invoke(e,"_onAdd",a,b);f>b;b++){var i=h[b];i&&g--,2>i&&_.invoke(e,"_doReduce",d[b],i)}}function b(){_.invoke(e,"_onReset");for(var a=f;a--;)h[a]=0;g=f}function c(a){function b(b,c){null==c&&(c=0),_.each(b,function(b,d){var e=a(b),f=l[e]||(l[e]={state:0,pointers:UintArray32(0),_pointers:[]}),g=c+d;f.state&&++h[g],f._pointers.push(g)}),_.each(l,function(a){_.isEmpty(a._pointers)||(a.pointers=UintArrayLengthen(a.pointers,a._pointers),a._pointers=[])})}function c(){var a=[];_.isFunction(arguments[0])?a.push(arguments[0]):arguments.length&&null!=arguments[0]?_.each(arguments,function(b){if(_.isArray(b))a.push(function(a){return a>=b[0]&&a<=b[1]});else if(b.indexOf("*")<0)a.push(function(a){return a==b||0===a.indexOf(b+h8.DELIMITER)});else{var c=new RegExp("^"+b.replace(new RegExp("\\"+h8.DELIMITER,"g"),"\\"+h8.DELIMITER).replace(new RegExp("\\*","g"),".*")+"$");a.push(function(a){return c.test(a)})}}):a.push(function(){return!0}),_.each(l,function(b,c){var f=_.some(a,function(a){return a(c)});if(f?b.state:!b.state){b.state=b.state?0:1;var i=_.without(e,n);f?_.each(b.pointers,function(a){var b=--h[a];0===b&&g++,2>b&&_.invoke(i,"_doReduce",d[a],b)}):_.each(b.pointers,function(a){var b=++h[a];1===b&&g--,3>b&&_.invoke(i,"_doReduce",d[a],b,!0)})}})}function f(b,c,d){var e=a(b);(l[e].state||(d?2!==c:1!==c))&&_.invoke(m,"_doReduce",b,e,d)}function i(){_.each(l,function(a,b){_.each(a.pointers,function(c){h[c]-a.state>0&&_.invoke(m,"_doReduce",d[c],b)}),a.state=0})}function j(){c(null),e.splice(_.indexOf(e,n),1),_.each(n,function(a,b,c){c[b]=null})}function k(a){function b(b,c,d){var e=f[c],g=a.memo(b),h=d?a.remove:a.add;f[c]=e?h(e,g):g}function c(b){b||(b={});var c=b.tree||{},d=b.key,e=b.final===!1||!a.final;return _.each(f,function(a,b){var e=c;_.each(b.split(h8.DELIMITER),function(a){var b=e.children||(e.children={});e=b[a]||(b[a]={})}),d?(e.value||(e.value={}))[d]=a:e.value=a}),function(b){var c=null;if(b.children){var f=_.map(b.children,arguments.callee),g=f.pop();c=_.reduce(f,function(b,c){return a.add(h8.cloneDeep(b),c)},g)}else c=d?b.value[d]:b.value;return d?(b.value||(b.value={}))[d]=e?c:a.final(c):b.value=e?c:a.final(c),c}(c),c}function e(){m.splice(_.indexOf(m,g),1),_.each(g,function(a,b,c){c[b]=null})}var f={},g={results:c,remove:e,_doReduce:b};return m.push(g),_.each(l,function(a,c){_.each(a.pointers,function(e){h[e]-a.state===0&&b(d[e],c)})}),g}var l={},m=[],n={select:c,reduce:k,remove:j,_onAdd:b,_onReset:i,_doReduce:f,selectAll:function(){return c(null)}};return arguments.length>1&&(a=_.toArray(arguments)),_.isArray(a)&&1===a.length&&(a=a[0]),a=_.wrap(a,_.isArray(a)?function(a,b){return _.map(a,function(a){var c=(a.group||a)(b);return c||(0===c?0:h8.WTF)}).join(h8.DELIMITER)}:function(a,b){var c=(a.group||a)(b);return c||(0===c?0:h8.WTF)}),e.push(n),b(d),n}var d=[],e=[],f=0,g=0,h=UintArray8(0),i={add:a,reset:b,group:c,total:function(){return f},selected:function(){return g}};return arguments[0]&&a(arguments[0]),i}var root=this,_;if("undefined"!=typeof require&&"undefined"!=typeof module&&module.exports)_=require("underscore"),module.exports=h8;else{if(_=root._,!_)throw new Error("underscore is needed.");var previousH8=root.h8;root.h8=h8,h8.noConflict=function(){return root.h8=previousH8,this}}h8.cloneDeep=function(a){if(!_.isObject(a))return a;if(_.isDate(a))return new Date(a.getTime());if(_.isArray(a)||_.isArguments(a))return _.map(a,h8.cloneDeep);var b={};return _.each(a,function(a,c){b[c]=h8.cloneDeep(a)}),b},h8.WTF="WTF",h8.DELIMITER=".";var UintArray8=function(){var a=arguments[0];if("undefined"!=typeof Uint8Array)return new Uint8Array(a);if(_.isNumber(a)){for(var b=new Array(a),c=a;c--;)b[c]=0;return b}return a},UintArray32=function(){var a=arguments[0];if("undefined"!=typeof Uint32Array)return new Uint32Array(a);if(_.isNumber(a)){for(var b=new Array(a),c=a;c--;)b[c]=0;return b}return a},UintArrayLengthen=function(a){var b=arguments[1];if(a.constructor.toString().indexOf("Uint")>-1){var c;if(_.isArray(b)){var d=a.length;c=new a.constructor(d+b.length),c.set(b,d)}else c=new a.constructor(b);return c.set(a),c}if(_.isArray(b))return a.concat(b);if(_.isNumber(b))for(var e=a.length;b>e;e++)a[e]=0;return a};h8.groups={register:function(a,b){this[a]=function(c){var d=_.defaults({group:_.wrap(b.group,function(a,b){return a.call(d,b,c)}),toJSON:_.wrap(b.toJSON,function(b){var e=b&&b.call(d)||null;return _.extend({key:a,field:c},e)})},b);return d}},toJSON:function(a){return a.toJSON?a.toJSON():{group:a.group&&a.group.toString()||a.toString(),order:a.order&&a.order.toString(),format:a.format&&a.format.toString()}},fromJSON:function(json){if(json.key){var funcs=this[json.key](json.field);return funcs.fromJSON&&funcs.fromJSON(json),funcs}return{group:eval("("+json.group+")"),order:eval("("+json.order+")"),format:eval("("+json.format+")")}}},h8.groups.register("all",{group:function(){return"all"}}),h8.groups.register("identity",{group:function(a,b){return a[b]},order:function(a){return a.key}}),h8.groups.register("range",{group:function(a,b){return _.sortedIndex(this._divides,a[b])},order:function(a){return+a.key},divides:function(a){return _.isArray(a)||(a=_.toArray(arguments)),this._divides=_.sortBy(a),this.refreshFormat()},labels:function(a){return _.isArray(a)||(a=_.toArray(arguments)),this._labels=a,this.refreshFormat()},refreshFormat:function(){var a=this._divides,b=this._labels||(this._labels=[]);if(a&&b){for(var c=0,d=a.length;d>=c;c++)b[c]||(b[c]=0===c?"<="+a[c]:c===d?">"+a[c-1]:a[c-1]+"~"+a[c]);this.format=function(a){return b[a]}}return this},toJSON:function(){var a=this;return{divides:a._divides,labels:a._labels}},fromJSON:function(a){return this.divides(a.divides),this.labels(a.labels),this}});var dateFormat=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a};h8.groups.register("decade",{group:function(a,b){var c=new Date(a[b]),d=c.getFullYear();return new Date(d-d%10,0).getTime()},order:function(a){return+a.key},format:function(a){var b=new Date(+a).getFullYear();return b-b%10+"s"}}),h8.groups.register("year",{group:function(a,b){var c=new Date(a[b]);return new Date(c.getFullYear(),0).getTime()},order:function(a){return+a.key},format:function(a){return dateFormat.call(new Date(+a),"yyyy")}}),h8.groups.register("month",{group:function(a,b){var c=new Date(a[b]);return new Date(c.getFullYear(),c.getMonth()).getTime()},order:function(a){return+a.key},format:function(a){return dateFormat.call(new Date(+a),"yyyy-MM")}}),h8.groups.register("day",{group:function(a,b){var c=new Date(a[b]);return new Date(c.getFullYear(),c.getMonth(),c.getDate()).getTime()},order:function(a){return+a.key},format:function(a){return dateFormat.call(new Date(+a),"yyyy-MM-dd")}}),h8.groups.register("hour",{group:function(a,b){var c=new Date(a[b]);return new Date(c.getFullYear(),c.getMonth(),c.getDate(),c.getHours()).getTime()},order:function(a){return+a.key},format:function(a){return dateFormat.call(new Date(+a),"yyyy-MM-dd hh:00")}}),h8.reduces={register:function(a,b){this[a]=function(c){var d,e,f,g,h,i=function(){if(arguments.length&&null!=arguments[0]){if(_.isString(arguments[0])){var a={},b=_.first(arguments),c=_.rest(arguments);return a[b]=1===c.length?{eq:c[0]}:{"in":c},[a]}return _.flatten(arguments)}return[]},j=function(a){if(!a.length)return null;var b=[],c=function(a,b,c){if("n"===b[0]){var d=arguments.callee.call(null,a,b.substring(1),c);return _.wrap(d,function(a,b){return!a.call(null,b)})}switch(b){case"gt":return function(b){return b[a]>c};case"lt":return function(b){return b[a]<c};case"gte":return function(b){return b[a]>=c};case"lte":return function(b){return b[a]<=c};case"eq":return function(b){return _.isEqual(b[a],c)};case"in":return function(b){return _.indexOf(c,b[a])>-1};case"like":return _.isArray(c)||(c=[c]),function(b){return _.some(c,function(c){return b[a].indexOf(c)>-1})};default:throw new Error("unaccept operator - "+b)}};return _.each(a,function(a){_.each(a,function(a,d){_.each(a,function(a,e){b.push(c(d,e,a))})})}),function(a){return _.every(b,function(b){return b(a)})}},k=_.defaults({focus:function(){var a=_.isFunction(arguments[0]);return d=a?null:i.apply(null,arguments),f=a?arguments[0]:j(d),this},ignore:function(){var a=_.isFunction(arguments[0]);return e=a?null:i.apply(null,arguments),g=a?arguments[0]:j(e),this},distinct:function(a){return a?(h=a,this.memo=_.wrap(this.memo,function(b,c){var d={counters:{},values:{},value:null},e=c[a];return d.counters[e]=1,d.values[e]=d.value=b.call(k,c),d}),this.add=_.wrap(this.add,function(a,b,c){return _.each(c.counters,function(d,e){if(d){var f=b.counters[e]||0;if(b.counters[e]=f+d,!f){var g=c.values[e];b.values[e]=g,b.value=a.call(k,b.value,g)}}}),b}),this.remove=_.wrap(this.remove,function(a,b,c){return _.each(c.counters,function(d,e){if(d){var f=b.counters[e]-d;b.counters[e]=f,f||(b.values[e]=null,b.value=a.call(k,b.value,c.values[e]))}}),b}),this.final=_.wrap(this.final,function(a,b){return a?a.call(k,b.value):b.value}),this):this},memo:_.wrap(b.memo,function(a,b){var d=!f||f(b),e=g&&g(b);return a.call(k,b,c,d&&!e)}),toJSON:_.wrap(b.toJSON,function(b){var i=b&&b.call(k)||null;return _.extend({key:a,field:c,distinct:h,focus:d||f&&f.toString(),ignore:e||g&&g.toString()},i)})},b);return k}},toJSON:function(a){return a.toJSON?a.toJSON():{memo:a.memo.toString(),add:a.add.toString(),remove:a.remove.toString(),"final":a.final&&a.final.toString(),format:a.format&&a.format.toString()}},fromJSON:function(json){if(json.key){var focus=_.isString(json.focus)?eval("("+json.focus+")"):json.focus,ignore=_.isString(json.ignore)?eval("("+json.ignore+")"):json.ignore,funcs=this[json.key](json.field).distinct(json.distinct).focus(focus).ignore(ignore);return funcs.fromJSON&&funcs.fromJSON(json),funcs}return{memo:eval("("+json.memo+")"),add:eval("("+json.add+")"),remove:eval("("+json.remove+")"),"final":eval("("+json.final+")"),format:eval("("+json.format+")")}}},h8.reduces.register("average",{memo:function(a,b,c){return{count:c?1:0,sum:c?+a[b]:0}},add:function(a,b){return{count:a.count+b.count,sum:a.sum+b.sum}},remove:function(a,b){return{count:a.count-b.count,sum:a.sum-b.sum}},"final":function(a){return a.count?a.sum/a.count:0},format:function(a){return a.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")}}),h8.reduces.register("count",{memo:function(a,b,c){return c?1:0},add:function(a,b){return a+b},remove:function(a,b){return a-b},format:function(a){return a.toFixed(0).replace(/(\d)(?=(\d{3})+\b)/g,"$1,")}}),h8.reduces.register("percent",{memo:function(a,b,c){return b?{value:c?+a[b]:0,total:+a[b]}:{value:c?1:0,total:1}},add:function(a,b){return{value:a.value+b.value,total:a.total+b.total}},remove:function(a,b){return{value:a.value-b.value,total:a.total-b.total}},"final":function(a){return a.total?a.value/a.total:0},format:function(a){return(100*a).toFixed(0).replace(/(\d)(?=(\d{3})+\b)/g,"$1,")+"%"}}),h8.reduces.register("sum",{memo:function(a,b,c){return c?+a[b]:0},add:function(a,b){return a+b},remove:function(a,b){return a-b},format:function(a){return a.toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g,"$1,")}}),h8.client=function(a){if(a=_.defaults(a,{heartbeat:12e4}),!a.datasource)throw new Error("datasource is needed!");if(!a.send)throw new Error("send handler is needed!");_.isFunction(a.filter)&&(a.filter=a.filter.toString());var b,c;return{setup:function(d,e){if(_.each(d.groups,function(a){_.isArray(a.funcs)||(a.funcs=[a.funcs]),_.each(a.funcs,function(a,b,c){c[b]=h8.groups.toJSON(a)}),_.isFunction(a.order)&&(a.order=a.order.toString())}),_.each(d.reduces,function(a){a.funcs=h8.reduces.toJSON(a.funcs)}),!b){var f=this;d=_.extend(d,_.omit(a,"send")),e=_.wrap(e,function(d,e){b=e.clientId,delete e.clientId,a.heartbeat&&(c=setInterval(function(){f.heartbeat()},a.heartbeat)),_.isFunction(d)&&d(e)})}a.send({client:b,verb:"setup",object:d},e)},select:function(c,d,e){_.isFunction(d[0])&&(d[0]=d[0].toString()),a.send({client:b,verb:"select",object:{groupId:c,selections:d}},e)},reset:function(c){a.send({client:b,verb:"reset",object:null},c)},heartbeat:function(c){a.send({client:b,verb:"heartbeat",object:null},c)},teardown:function(d,e){return 1===arguments.length&&_.isFunction(d)&&(e=d,d=null),b?(null==d&&(clearInterval(c),_.defer(function(){b=null})),void a.send({client:b,verb:"teardown",object:d},e)):_.isFunction(e)&&e()}}},h8.server=function(options){options||(options={});var logger=_.defaults(options.logger||console||{},{debug:function(){},log:function(){},warn:function(){},error:function(){}}),clients={},initClient=function(data,callback){var getRecords=_.isArray(data.datasource)?function(a,b){b(null,a)}:options.getRecords;if(!getRecords)throw new Error("getRecords callback is needed!");getRecords(data.datasource,function(err,records){logger[err?"warn":"debug"]("Getting records of[ %s ] %s.",data.datasource,err?"failed":"successfully"),err&&(records=[]),data.filter&&(records=_.filter(records,eval("("+data.filter+")")));var clientId=_.uniqueId("client_"),client=clients[clientId]={id:clientId,records:h8(records),groups:{},reduces:{},heartbeat:data.heartbeat};client.heartbeat&&handlers.heartbeat(client,data,function(){}),callback(client)})},getResults=function(a,b,c){var d={total:a.records.total(),selected:a.records.selected(),groups:{}};_.each(a.reduces,function(a){var b=d.groups[a.groupId]||(d.groups[a.groupId]={});a.reduce.results({tree:b,key:a.key})}),_.each(a.groups,function(a,b){var c=d.groups[b];c&&(c=function(b,c){var d=arguments.callee;if(b.children){b.children=_.map(b.children,function(a,b){return a.key=b,d.call(null,a,c+1)});var e=a.funcs[c].order;e&&(b.children=_.sortBy(b.children,e))}return b}(c,0),(a.top||a.bottom)&&(c.children=_.first(c.children,a.top||a.bottom)),d.groups[b]=c)}),b(_.defaults(d,c))},handlers={setup:function(client,data,callback,defaults){if(!client){var self=arguments.callee,that=this;return initClient(data,function(a){self.call(that,a,data,callback,{clientId:a.id,WTF:h8.WTF})})}_.each(data.groups,function(tuple){_.each(tuple.funcs,function(a,b,c){c[b]=h8.groups.fromJSON(a)}),tuple.order=tuple.order||tuple.top&&"desc"||tuple.bottom&&"asc"||null,tuple.order&&(_.isString(tuple.order)&&tuple.order.indexOf("function")>-1?tuple.order=eval("("+tuple.order+")"):("asc"===tuple.order&&(tuple.order=function(a){return _.isObject(a.value)?_.reduce(a.value,function(a,b){return a+b},0):a.value}),"desc"===tuple.order&&(tuple.order=function(a){return _.isObject(a.value)?_.reduce(a.value,function(a,b){return a-b},0):-a.value})),tuple.funcs[0].order=tuple.order,delete tuple.order),tuple.group=client.records.group(tuple.funcs),client.groups[tuple.id]=tuple}),_.each(data.reduces,function(a){a.funcs=h8.reduces.fromJSON(a.funcs),a.reduce=client.groups[a.groupId].group.reduce(a.funcs),client.reduces[a.id]=a}),getResults(client,callback,defaults)},select:function(client,data,callback){_.isString(data.selections[0])&&data.selections[0].indexOf("function")>-1&&(data.selections[0]=eval("("+data.selections[0]+")")),client.groups[data.groupId].group.select.apply(null,data.selections),getResults(client,callback)},reset:function(a,b,c){a.records.reset(),getResults(a,c)},heartbeat:function(a,b,c){clearTimeout(a.heartbeatHandler),a.heartbeatHandler=setTimeout(function(){delete clients[a.id]},+a.heartbeat+2e4),c(a.id)},teardown:function(a,b,c){_.each(b.groups,function(b){a.groups[b]&&(a.groups[b].group.remove(),delete a.groups[b],_.each(a.reduces,function(c,d){c.groupId===b&&delete a.reduces[d]}))}),_.each(b.reduces,function(b){a.reduces[b]&&(a.reduces[b].reduce.remove(),delete a.reduces[b])}),b.groups||b.reduces?getResults(a,c):(clearTimeout(a.heartbeatHandler),delete clients[a.id],c(a.id))}};return{receive:function(a,b){var c=handlers[a.verb],d=clients[a.client];return b=b||function(){},!c||!d&&"setup"!==a.verb?b():void c.call(handlers,d,a.object||{},b)}}}}).call(this);